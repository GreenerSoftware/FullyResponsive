name: app

on:
  push:
    branches:
      - main
    paths:
    # Build when there are changes in the directory that holds the component,
    # or when this workflow file is changed
    - 'app/**'
    - '.github/workflows/app.yml'
  schedule:
    # A weekly build to pick up updates and security patches for libraries
    # This should fail if there are API changes in new dependency versions
    - cron: "11 11 * * 5"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Lambda
    runs-on: ubuntu-latest
    env:
      buildsBucket: ${{ vars.BUILDS_BUCKET }}
      lambdaName: ${{ vars.APP_LAMBDA }}
      bucket: ${{ vars.CLOUDFRONT_BUCKET }}
      distributionId: ${{ vars.CLOUDFRONT_DISTRIBUTIONID }}

    steps:

    - uses: actions/checkout@v3

    - uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ vars.GHA_OIDC_ROLE }}
        aws-region: eu-west-2

    - name: Set up nvm
      working-directory: ${{ github.workflow }}
      run: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
        nvm install 20
        nvm use 20

    - name: Build
      working-directory: ${{ github.workflow }}
      run: |
        # Based on the Dockerfile in the /app component directory
        npm i
        npm run build

    - name: Upload assets to s3
      working-directory: ${{ github.workflow }}
      run: |
        # app assets
        mkdir deer-return
        cp -r assets deer-return/
        cp -r node_modules/govuk-frontend deer-return/
        cp -r node_modules/naturescot-frontend deer-return/
        aws s3 sync --delete deer-return s3://${bucket}/deer-return/

    - name: Package
      working-directory: ${{ github.workflow }}
      run: |
        # npm prune --production
        npm run package

    - name: Update function code
      working-directory: ${{ github.workflow }}
      run: |
        aws s3 cp dist/function.zip s3://${{ env.buildsBucket }}/${{ github.workflow }}.zip
        aws lambda update-function-code --function-name=${{ env.lambdaName }} --s3-bucket ${{ env.buildsBucket }} --s3-key ${{ github.workflow }}.zip

    - name: Invalidate Cloudfront
      working-directory: ${{ github.workflow }}
      run: |
        aws cloudfront create-invalidation --distribution-id $distributionId --paths '/*'
